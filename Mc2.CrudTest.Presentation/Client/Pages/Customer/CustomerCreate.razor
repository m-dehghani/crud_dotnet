<!-- CreateCustomer.razor -->
@page "/create-customer"
@using System.ComponentModel.DataAnnotations
@using Mc2.CrudTest.Presentation.Shared.ValueObjects
@inject HttpClient Http
@inject NavigationManager NavigationManager

<h3>Create New Customer</h3>

<EditForm Model="@_newCustomer" OnValidSubmit="CreateCustomer">
    <DataAnnotationsValidator />
    
    <div class="form-group">
        <label for="firstName">First Name</label>
        <InputText id="firstName" @bind-Value="_newCustomer.FirstName" class="form-control" />
        <ValidationMessage For="@(() => _newCustomer.FirstName)" />
    </div>
    <div class="form-group">
        <label for="lastName">Last Name</label>
        <InputText id="lastName" @bind-Value="_newCustomer.LastName" class="form-control" />
        <ValidationMessage For="@(() => _newCustomer.FirstName)" />
    </div>
    <div class="form-group">
        <label for="email">Email</label>
        <InputText id="email" @bind-Value="_newCustomer.Email" class="form-control" />
        <ValidationMessage For="@(() => _newCustomer.Email)" />
    </div>
    <div class="form-group">
        <label for="phoneNumber">Phone Number</label>
        <InputText id="phoneNumber" @bind-Value="_newCustomer.PhoneNumber" class="form-control" />
        <ValidationMessage For="@(() => _newCustomer.PhoneNumber)" />
    </div>
    <div class="form-group">
        <label for="dateOfBirth">DateOfBirth</label>
        <InputText id="dateOfBirth" @bind-Value="_newCustomer.DateOfBirth" class="form-control" />
        <ValidationMessage For="@(() => _newCustomer.DateOfBirth)" />
    </div>

    <div class="form-group">
        <label for="bankAccount">BankAccount</label>
        <InputText id="bankAccount" @bind-Value="_newCustomer.BankAccount" class="form-control" />
        <ValidationMessage For="@(() => _newCustomer.BankAccount)" />
    </div>

    <button class="btn btn-primary" @onclick="CreateCustomer">Create</button> <div>@_errorMessage</div>
</EditForm>

@code {
    private CustomerCreateModel _newCustomer = new CustomerCreateModel();
    private string _errorMessage = "";
    private async Task CreateCustomer()
    {
        try
        {
            bool validateAllProperties = false;
            var validationResult = new List<ValidationResult>();
            var isValid = Validator.TryValidateObject(_newCustomer, new ValidationContext(_newCustomer, null, null), 
                validationResult, validateAllProperties);

            var result =    await Http.PostAsJsonAsync("Customer", _newCustomer);
            if (result.IsSuccessStatusCode)
                NavigationManager.NavigateTo("customers");
            else
                _errorMessage = await result.Content.ReadAsStringAsync();
            // Redirect to customer list or show success message
        }
        
        catch (Exception ex)
        {
            _errorMessage += "An error has been occured. Please try again later.";
        }
    }

    private class CustomerCreateModel : IValidatableObject
    {
        public string FirstName { get;  set; }
        public string LastName { get;  set; }
        public string BankAccount { get;  set; }
        public string DateOfBirth { get;  set; }
        public string PhoneNumber { get;  set; }
        public string Email { get;  set; }


        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            var results = new List<ValidationResult>();
          
                try
                {
                    _ = new Email(this.Email);
                }catch
                {
                    results.Add(new ValidationResult("Enter valid email"));
                }
                try
                {
                    _ = new BankAccount(this.BankAccount);
                }catch
                {
                    results.Add(new ValidationResult("Enter valid Bank Account"));
                }
          
            return results;
        }
    }
}